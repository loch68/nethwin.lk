<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Profile - NethwinLK</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
  <link rel="stylesheet" href="../css/hover-effects.css" />
  <link rel="stylesheet" href="../css/responsive.css" />
</head>
<body>
  <div class="relative flex min-h-screen flex-col bg-white overflow-x-hidden font-[Inter, 'Noto Sans', sans-serif]">
    <div class="layout-container flex flex-col grow h-full">
      <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#f2f4f1] px-10 py-3">
        <div class="flex items-center gap-4 text-[#151612]">
          <div class="h-10">
            <a href="index.html" aria-label="Go to Home">
              <img src="../assets/fLogo.png" alt="NETHWIN Logo" class="h-10 w-auto" />
            </a>
          </div>
        </div>
        <div class="flex gap-2">
          <button id="logoutBtn" class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-[#f2f4f1] text-[#151612] text-sm font-bold">Logout</button>
        </div>
      </header>

      <div class="px-40 flex flex-1 justify-center py-5">
        <div class="layout-content-container flex flex-col max-w-[960px] flex-1">
          <h2 class="text-[#111418] tracking-light text-[28px] font-bold leading-tight px-4 text-left pb-3 pt-5">My Profile</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 px-4">
            <form id="profileForm" class="space-y-4 bg-white p-4 rounded-lg border border-[#e2e5dc]">
              <div>
                <label class="block text-sm font-medium text-[#0e1a13] mb-1">Full Name</label>
                <input id="fullName" class="w-full px-3 py-2 border border-[#d1e6d9] rounded-lg" />
              </div>
              <div>
                <label class="block text-sm font-medium text-[#0e1a13] mb-1">Email</label>
                <input id="email" disabled class="w-full px-3 py-2 border border-[#d1e6d9] rounded-lg bg-gray-100" />
              </div>
              <div>
                <label class="block text-sm font-medium text-[#0e1a13] mb-1">Phone</label>
                <input id="phone" class="w-full px-3 py-2 border border-[#d1e6d9] rounded-lg" />
              </div>
              <button class="bg-[#19e619] text-white py-2 px-4 rounded-lg">Save</button>
            </form>

            <div class="bg-white p-4 rounded-lg border border-[#e2e5dc]">
              <h3 class="text-[#111418] text-lg font-bold pb-2">Past Orders</h3>
              <div id="orders" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function getToken(){ try { return localStorage.getItem('authToken'); } catch { return null; } }
    async function fetchMe(){
      const res = await fetch('/api/me', { headers:{ Authorization: 'Bearer ' + getToken() } });
      if (!res.ok) throw new Error('Unauthorized');
      return res.json();
    }
    async function fetchOrders(){
      const res = await fetch('/api/my-orders', { headers:{ Authorization: 'Bearer ' + getToken() } });
      if (!res.ok) return { orders: [] };
      return res.json();
    }
    async function saveProfile(payload){
      const res = await fetch('/api/me', { method:'PUT', headers:{ 'Content-Type':'application/json', Authorization: 'Bearer ' + getToken() }, body: JSON.stringify(payload) });
      if (!res.ok) throw new Error('Save failed');
      return res.json();
    }

    (async function init(){
      try {
        const me = await fetchMe();
        document.getElementById('fullName').value = me.user.fullName || '';
        document.getElementById('email').value = me.user.email || '';
        document.getElementById('phone').value = me.user.phone || '';
        const data = await fetchOrders();
        const wrap = document.getElementById('orders');
        wrap.innerHTML = '';
        (data.orders || []).forEach(o => {
          const div = document.createElement('div');
          div.className = 'border border-[#d1e6d9] rounded p-3 text-sm text-[#0e1a13]';
          div.innerHTML = `#${o._id} 路 ${o.type || 'shop'} 路 LKR ${Number(o.total||0).toFixed(2)} 路 ${(o.createdAt||'').slice(0,10)} 路 ${o.status}`;
          wrap.appendChild(div);
        });
      } catch (e) {
        window.location.href = 'login.html';
      }
    })();

    document.getElementById('profileForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        await saveProfile({ fullName: document.getElementById('fullName').value.trim(), phone: document.getElementById('phone').value.trim() });
        alert('Saved');
      } catch { alert('Save failed'); }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
      try { localStorage.removeItem('authToken'); } catch {}
      window.location.href = 'index.html';
    });
  </script>
</body>
</html>


